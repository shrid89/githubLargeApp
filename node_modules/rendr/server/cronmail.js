var CronJob = require('../../cron').CronJob;
var MockmAppMailer = require('./mailer');
var Mailer = new MockmAppMailer();
var MongoAdapter = require('rendr/server/data_adapter/mongo_adapter');
var DataAdapter = new MongoAdapter();

CronMailer = function() {};
CronMailer.prototype.sendmail = function(req, callback) {
    var job = new CronJob('00 1,2,3,4,5,6,7,8,9,10,11,12,14,16,18,20,22,23,26,28,30,33,35,38,40,42,43,44,45,46,47,48,49,50,52,54,56,58 0,1,2,4,6,8,10,12,13,14,15,16,17,18,19,20,21,22,23,24 * * 0-6',
            function() {
                var MailBody = "<h2>Your free trial of our  <span style='color:#BF5C45;'> Professional </span> plan has ended.</h2><br /> <p>Time flies when you're having fun huh? We hope you've enjoyed using <span style='text-decoration:none;color:#359FE6;'> Mockm </span>so far -- and if you want to continue using it long into the future! click the below link:<p><br/> <a target='_blank' href='http://mockm.com'>http://mockm.com</a><br /><br />Thanks,<br />Mockm Team";
                var Today = new Date();
                var Month = Today.getMonth() + 1,
                Year = Today.getFullYear(),
                Day = Today.getDate();
                var PlanRequest = {query: {'PlanExpired': false, 'EndDate': {"$gte": new Date(Year+','+ Month+','+(Day-1)), "$lt": new Date(Year+','+Month+','+Day)}}};
                DataAdapter.request(PlanRequest, {path: 'GetUserPlan'}, {convertErrorCode: false}, function(callback) {
                    if(callback.length > 0)  {
                        var UserRequest = {query: {'_id': callback[0].UserID}};                        
                        DataAdapter.request(UserRequest, {path: 'GetUser'}, {convertErrorCode: false}, function(userCallback) {
                            if(typeof(userCallback) != 'undefined' && typeof(userCallback[0]) != 'undefined' && typeof(userCallback[0].Active) != 'undefined' &&  userCallback[0].Active != 0) {
                                var UserData = {query: {_id: userCallback[0]._id, Active: false}};
                                DataAdapter.request(UserData, {path: 'UpdateUserActivation'}, {convertErrorCode: false}, function(activationCallback) {
                                    var Body = "Hi,<br /><br />"
                                    Body += MailBody;  
                                    var MailDetails = {
                                        EmailAddress: userCallback[0].EmailAddress,                                        
                                        Subject: 'Your Mockm Trial has Ended',
                                        EmailBody: Body
                                    }
                                    var MailReq = {query: MailDetails};
                                    Mailer.mail(MailReq, function(error, response) {});
                                    var PlanUpdate = {query: {'_id': callback[0]._id, 'PlanExpired': true}};
                                    DataAdapter.request(PlanUpdate, {path: 'UpdateUserPlan'}, {convertErrorCode: false}, function(activationCallback) {
                                    });
                                });
                            }
                        });
                    }
                });

            }, function() {
    },
            true
            );
}
module.exports = CronMailer;